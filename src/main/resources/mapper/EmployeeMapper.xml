<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper
        PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.example.mapper.EmployeeMapper">

    <!-- Complex JOIN Example -->
    <select id="findAllWithDepartmentAndProject" resultType="com.example.entity.EmployeeEntity">
        SELECT e.id, e.name, e.salary,
        d.name AS department_name,
        p.name AS project_name
        FROM employee e
        JOIN department d ON e.department_id = d.id
        JOIN project p ON e.project_id = p.id
    </select>

    <!-- Dynamic Search + Pagination -->
    <select id="searchEmployees" resultType="com.example.entity.EmployeeEntity">
        SELECT e.*, d.name AS department_name, p.name AS project_name
        FROM employee e
        LEFT JOIN department d ON e.department_id = d.id
        LEFT JOIN project p ON e.project_id = p.id
        <where>
            <if test="search != null and search != ''">
                (LOWER(e.name) LIKE CONCAT('%', LOWER(#{search}), '%')
                OR LOWER(d.name) LIKE CONCAT('%', LOWER(#{search}), '%')
                OR LOWER(p.name) LIKE CONCAT('%', LOWER(#{search}), '%'))
            </if>
        </where>
        ORDER BY
        <choose>
            <when test="sortBy != null and sortBy != ''">${sortBy}</when>
            <otherwise>e.id</otherwise>
        </choose>
        <choose>
            <when test="sortOrder == 'desc'">DESC</when>
            <otherwise>ASC</otherwise>
        </choose>
        LIMIT #{limit} OFFSET #{offset}
    </select>

</mapper>
